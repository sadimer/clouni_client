- name: install base packages
  apt:
    name:
      - "git"
      - "python3-pip"
    update_cache: yes
  become: yes

- name: Install and run
  shell: |
    python3 -m pip install grpcio==1.37.1
    python3 -m pip install grpcio-tools==1.37.1
    python3 -m pip install -i https://test.pypi.org/simple/ grpc-cotea==0.9.5
    python3 -m pip install ansible==2.9.19
    python3 -m pip install openstacksdk==0.46.1
    python3 -m pip install boto3 botocore urllib3 bs4
  become: true

- name: Create openstack dir
  shell: mkdir -p /etc/openstack
  become: true

- name: Create openstack dir
  shell: |
    mkdir -p /tmp/clouni/ansible
    mkdir -p /tmp/clouni/artifacts

- name: Generate an OpenSSH keypair with the default values (4096 bits, rsa)
  community.crypto.openssh_keypair:
    path: /root/.ssh/id_rsa
  become: true

- name: Copy file
  become: true
  copy:
    src: "/etc/openstack/clouds.yaml"
    dest: "/etc/openstack"

- name: Run server
  shell: setsid grpc-cotea -p {{ port }} --host {{ ansible_default_ipv4.address }} >/home/{{ user }}/cotea.log 2>&1 < /dev/null &
  become: true

    

